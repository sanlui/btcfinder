<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorer Bitcoin Avanzato</title>
  <style>
    :root {
      --primary: #f7931a;
      --primary-hover: #e07b0a;
      --secondary: #f0f0f0;
      --text: #333;
      --error: #d32f2f;
      --success: #388e3c;
    }
    
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 20px; 
      color: var(--text);
      line-height: 1.6;
    }
    
    h1 { color: var(--primary); text-align: center; }
    
    .search-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 30px 0;
    }
    
    input, button, select { 
      padding: 10px 12px; 
      font-size: 16px; 
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    
    input { 
      flex: 1; 
      min-width: 250px;
    }
    
    button { 
      cursor: pointer; 
      background: var(--primary); 
      color: white; 
      border: none; 
      font-weight: bold;
      transition: background 0.2s;
    }
    
    button:hover { background: var(--primary-hover); }
    
    .result { 
      background: var(--secondary); 
      padding: 20px; 
      margin-top: 30px; 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    h2 { margin-top: 30px; color: var(--primary); }
    h3 { margin-top: 20px; }
    
    pre { white-space: pre-wrap; word-wrap: break-word; }
    
    ul { padding-left: 20px; }
    li { margin-bottom: 8px; }
    
    .tx-link { 
      color: var(--primary); 
      text-decoration: none;
      font-family: monospace;
    }
    
    .tx-link:hover { text-decoration: underline; }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .data-row {
      display: flex;
      margin-bottom: 8px;
    }
    
    .data-label {
      font-weight: bold;
      min-width: 180px;
    }
    
    .shorten {
      display: inline-block;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    
    .confirmed { background: var(--success); color: white; }
    .unconfirmed { background: #ff9800; color: white; }
    
    @media (max-width: 600px) {
      .search-container { flex-direction: column; }
      input { width: 100%; }
      .data-row { flex-direction: column; }
      .data-label { min-width: auto; margin-bottom: 4px; }
    }
    
    .copy-btn {
      background: #666;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .copy-btn:hover { background: #555; }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      font-weight: bold;
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>

  <h1>Explorer Bitcoin Avanzato</h1>

  <div class="search-container">
    <select id="searchType">
      <option value="tx">Transazione (TXID)</option>
      <option value="address">Indirizzo</option>
      <option value="block">Blocco (numero o hash)</option>
    </select>
    
    <input type="text" id="searchInput" placeholder="Inserisci TXID, indirizzo o blocco" />
    
    <button id="searchBtn" onclick="performSearch()">Cerca</button>
  </div>

  <div id="result" class="result"></div>

<script>
  // Cache semplice
  const cache = {
    data: {},
    get(key) {
      return this.data[key] || null;
    },
    set(key, value) {
      this.data[key] = value;
      // Rimuove dalla cache dopo 5 minuti
      setTimeout(() => delete this.data[key], 300000);
    }
  };

  // Formattazione numeri
  function formatBTC(satoshi) {
    return (satoshi / 1e8).toFixed(8) + ' BTC';
  }
  
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  
  function shortenHash(hash) {
    if (hash.length > 20) {
      return `${hash.substring(0, 10)}...${hash.substring(hash.length - 10)}`;
    }
    return hash;
  }
  
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Mostra feedback visivo
      const btn = document.getElementById('copy-feedback');
      if (btn) {
        btn.textContent = 'Copiato!';
        setTimeout(() => btn.textContent = 'Copia', 2000);
      }
    });
  }

  // Supporto per Invio nella casella di testo
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') performSearch();
  });
  
  // Validazione input
  function validateInput(type, query) {
    if (!query) {
      throw new Error('Inserisci un valore valido');
    }
    
    if (type === 'tx') {
      if (!/^[a-fA-F0-9]{64}$/.test(query)) {
        throw new Error('TXID non valido. Deve essere 64 caratteri esadecimali');
      }
    } else if (type === 'address') {
      if (!/^([13][a-km-zA-HJ-NP-Z1-9]{25,34}|bc1[a-z0-9]{39,59})$/.test(query)) {
        throw new Error('Indirizzo Bitcoin non valido');
      }
    } else if (type === 'block') {
      if (!/^[0-9]+$/.test(query) && !/^[a-fA-F0-9]{64}$/.test(query)) {
        throw new Error('Blocco non valido. Inserisci un numero (altezza) o hash (64 caratteri esadecimali)');
      }
    }
  }

  async function performSearch() {
    const type = document.getElementById('searchType').value;
    const query = document.getElementById('searchInput').value.trim();
    const resultDiv = document.getElementById('result');
    const originalContent = resultDiv.innerHTML;
    
    try {
      validateInput(type, query);
      
      resultDiv.innerHTML = '<div class="loader"></div><p style="text-align:center;">Caricamento dati...</p>';
      
      if (type === 'tx') {
        await searchTransaction(query, resultDiv);
      } else if (type === 'address') {
        await searchAddress(query, resultDiv);
      } else if (type === 'block') {
        await searchBlock(query, resultDiv);
      }
    } catch (e) {
      resultDiv.innerHTML = `<p style="color:${var(--error)};"><strong>Errore:</strong> ${e.message}</p>${originalContent}`;
    }
  }

  async function searchTransaction(txid, container) {
    // Controlla la cache prima
    const cachedData = cache.get(`tx_${txid}`);
    if (cachedData) {
      renderTransaction(cachedData, container);
      return;
    }
    
    const [txRes, txStatusRes] = await Promise.all([
      fetch(`https://blockstream.info/api/tx/${txid}`),
      fetch(`https://blockstream.info/api/tx/${txid}/status`)
    ]);
    
    if (!txRes.ok || !txStatusRes.ok) throw new Error('Transazione non trovata');
    
    const tx = await txRes.json();
    const txStatus = await txStatusRes.json();
    
    // Aggiungi status alla transazione
    tx.status = txStatus;
    
    // Salva in cache
    cache.set(`tx_${txid}`, tx);
    
    renderTransaction(tx, container);
  }
  
  function renderTransaction(tx, container) {
    let html = `<h2>Dettagli Transazione</h2>`;
    
    html += `<div class="data-row">
      <div class="data-label">TXID:</div>
      <div>${tx.txid} <button class="copy-btn" onclick="copyToClipboard('${tx.txid}')" id="copy-feedback">Copia</button></div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Stato:</div>
      <div>${tx.status.confirmed ? 
        `<span class="badge confirmed">Confermato</span> (Blocco #${tx.status.block_height})` : 
        `<span class="badge unconfirmed">Non confermato</span>`}
      </div>
    </div>`;
    
    if (tx.status.confirmed) {
      html += `<div class="data-row">
        <div class="data-label">Conferme:</div>
        <div>${formatNumber(tx.status.block_height)}</div>
      </div>`;
    }
    
    html += `<div class="data-row">
      <div class="data-label">Data/Ora:</div>
      <div>${tx.status.confirmed ? 
        new Date(tx.status.block_time * 1000).toLocaleString() : 
        'In mempool (non confermato)'}
      </div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Dimensione:</div>
      <div>${formatNumber(tx.size)} bytes</div>
    </div>`;
    
    // Calcola il fee se disponibile
    if (tx.vin && tx.vout) {
      const inputSum = tx.vin.reduce((sum, vin) => sum + (vin.prevout?.value || 0), 0);
      const outputSum = tx.vout.reduce((sum, vout) => sum + vout.value, 0);
      const fee = inputSum - outputSum;
      
      if (fee > 0) {
        html += `<div class="data-row">
          <div class="data-label">Fee:</div>
          <div>${formatBTC(fee)} (${formatNumber(fee)} satoshi)</div>
        </div>`;
        
        html += `<div class="data-row">
          <div class="data-label">Fee rate:</div>
          <div>${(fee / tx.size).toFixed(2)} satoshi/byte</div>
        </div>`;
      }
    }
    
    // Input e Output
    html += `<div class="tabs">
      <div class="tab active" onclick="switchTab('inputs', 'outputs')">Input (${tx.vin.length})</div>
      <div class="tab" onclick="switchTab('outputs', 'inputs')">Output (${tx.vout.length})</div>
    </div>`;
    
    // Tab Input
    html += `<div id="inputs" class="tab-content active"><ul>`;
    tx.vin.forEach((vin, i) => {
      const address = vin.prevout?.scriptpubkey_address || 'Coinbase (nuova generazione di coin)';
      const value = vin.prevout?.value ? formatBTC(vin.prevout.value) : 'N/A';
      
      html += `<li>
        <strong>Input #${i + 1}:</strong> 
        ${address.startsWith('Coinbase') ? address : 
          `<a href="#" class="tx-link" onclick="performSearchAddress('${address}')">${address}</a>`}
        - ${value}
        ${vin.txid ? `<br><small>Da TX: <a href="#" class="tx-link" onclick="performSearchTx('${vin.txid}')">${shortenHash(vin.txid)}</a></small>` : ''}
      </li>`;
    });
    html += `</ul></div>`;
    
    // Tab Output
    html += `<div id="outputs" class="tab-content"><ul>`;
    tx.vout.forEach((vout, i) => {
      const address = vout.scriptpubkey_address || 'N/A (script non standard)';
      html += `<li>
        <strong>Output #${i + 1}:</strong> 
        ${address === 'N/A (script non standard)' ? address : 
          `<a href="#" class="tx-link" onclick="performSearchAddress('${address}')">${address}</a>`}
        - ${formatBTC(vout.value)}
      </li>`;
    });
    html += `</ul></div>`;
    
    container.innerHTML = html;
  }

  async function searchAddress(address, container) {
    const cachedData = cache.get(`addr_${address}`);
    if (cachedData) {
      renderAddress(cachedData, address, container);
      return;
    }
    
    const [addrRes, txsRes] = await Promise.all([
      fetch(`https://blockstream.info/api/address/${address}`),
      fetch(`https://blockstream.info/api/address/${address}/txs`)
    ]);
    
    if (!addrRes.ok) throw new Error('Indirizzo non trovato');
    
    const addrInfo = await addrRes.json();
    const txs = txsRes.ok ? await txsRes.json() : [];
    
    const data = { addrInfo, txs };
    cache.set(`addr_${address}`, data);
    
    renderAddress(data, address, container);
  }
  
  function renderAddress(data, address, container) {
    const { addrInfo, txs } = data;
    
    const confirmedBalance = (addrInfo.chain_stats.funded_txo_sum - addrInfo.chain_stats.spent_txo_sum) / 1e8;
    const unconfirmedBalance = (addrInfo.mempool_stats.funded_txo_sum - addrInfo.mempool_stats.spent_txo_sum) / 1e8;
    const totalReceived = addrInfo.chain_stats.funded_txo_sum / 1e8;
    const totalSent = addrInfo.chain_stats.spent_txo_sum / 1e8;
    
    let html = `<h2>Dettagli Indirizzo</h2>`;
    
    html += `<div class="data-row">
      <div class="data-label">Indirizzo:</div>
      <div>${address} <button class="copy-btn" onclick="copyToClipboard('${address}')" id="copy-feedback">Copia</button></div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Saldo confermato:</div>
      <div>${confirmedBalance.toFixed(8)} BTC</div>
    </div>`;
    
    if (unconfirmedBalance !== 0) {
      html += `<div class="data-row">
        <div class="data-label">Saldo non confermato:</div>
        <div>${unconfirmedBalance.toFixed(8)} BTC</div>
      </div>`;
    }
    
    html += `<div class="data-row">
      <div class="data-label">Totale ricevuto:</div>
      <div>${totalReceived.toFixed(8)} BTC</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Totale inviato:</div>
      <div>${totalSent.toFixed(8)} BTC</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Numero transazioni:</div>
      <div>${formatNumber(addrInfo.chain_stats.tx_count + addrInfo.mempool_stats.tx_count)}</div>
    </div>`;
    
    // Mostra ultime transazioni
    html += `<h3>Ultime transazioni</h3>`;
    
    if (txs.length === 0) {
      html += `<p>Nessuna transazione trovata</p>`;
    } else {
      html += `<ul>`;
      txs.slice(0, 10).forEach(tx => {
        const isOutgoing = tx.vin.some(vin => vin.prevout?.scriptpubkey_address === address);
        html += `<li>
          <span class="badge ${isOutgoing ? 'unconfirmed' : 'confirmed'}">${isOutgoing ? 'Inviato' : 'Ricevuto'}</span>
          <a href="#" class="tx-link" onclick="performSearchTx('${tx.txid}')">${shortenHash(tx.txid)}</a>
          (${formatBTC(isOutgoing ? 
            tx.vout.reduce((sum, v) => sum + (v.scriptpubkey_address !== address ? v.value : 0), 0) :
            tx.vout.reduce((sum, v) => sum + (v.scriptpubkey_address === address ? v.value : 0), 0))})
          ${tx.status.confirmed ? 
            `<small>${new Date(tx.status.block_time * 1000).toLocaleDateString()}</small>` : 
            '<small>In mempool</small>'}
        </li>`;
      });
      html += `</ul>`;
    }
    
    container.innerHTML = html;
  }

  async function searchBlock(blockQuery, container) {
    const cachedData = cache.get(`block_${blockQuery}`);
    if (cachedData) {
      renderBlock(cachedData, container);
      return;
    }
    
    let blockHash = blockQuery;
    
    // Se è un numero (altezza blocco)
    if (/^\d+$/.test(blockQuery)) {
      const hashRes = await fetch(`https://blockstream.info/api/block-height/${blockQuery}`);
      if (!hashRes.ok) throw new Error('Blocco non trovato');
      blockHash = await hashRes.text();
    }
    
    const [blockRes, txsRes] = await Promise.all([
      fetch(`https://blockstream.info/api/block/${blockHash}`),
      fetch(`https://blockstream.info/api/block/${blockHash}/txs`)
    ]);
    
    if (!blockRes.ok) throw new Error('Blocco non trovato');
    
    const block = await blockRes.json();
    const txs = txsRes.ok ? await txsRes.json() : [];
    
    const data = { block, txs, blockHash };
    cache.set(`block_${blockQuery}`, data);
    cache.set(`block_${blockHash}`, data);
    
    renderBlock(data, container);
  }
  
  function renderBlock(data, container) {
    const { block, txs, blockHash } = data;
    
    let html = `<h2>Dettagli Blocco</h2>`;
    
    html += `<div class="data-row">
      <div class="data-label">Altezza:</div>
      <div>${formatNumber(block.height)}</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Hash:</div>
      <div>${blockHash} <button class="copy-btn" onclick="copyToClipboard('${blockHash}')" id="copy-feedback">Copia</button></div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Data/Ora:</div>
      <div>${new Date(block.timestamp * 1000).toLocaleString()}</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Numero transazioni:</div>
      <div>${formatNumber(block.tx_count)}</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Dimensione:</div>
      <div>${formatNumber(block.size)} bytes</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Difficoltà:</div>
      <div>${formatNumber(Math.round(block.difficulty))}</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Versione:</div>
      <div>0x${block.version.toString(16)}</div>
    </div>`;
    
    html += `<div class="data-row">
      <div class="data-label">Merkle Root:</div>
      <div>${block.merkle_root}</div>
    </div>`;
    
    // Ultime transazioni del blocco
    html += `<h3>Ultime transazioni</h3>`;
    
    if (txs.length === 0) {
      html += `<p>Nessuna transazione disponibile</p>`;
    } else {
      html += `<ul>`;
      txs.slice(0, 10).forEach(tx => {
        html += `<li>
          <a href="#" class="tx-link" onclick="performSearchTx('${tx.txid}')">${shortenHash(tx.txid)}</a>
          (${formatBTC(tx.vout.reduce((sum, v) => sum + v.value, 0))})
        </li>`;
      });
      html += `</ul>`;
    }
    
    container.innerHTML = html;
  }

  // Funzioni helper per cercare da link
  function performSearchTx(txid) {
    document.getElementById('searchType').value = 'tx';
    document.getElementById('searchInput').value = txid;
    performSearch();
  }
  
  function performSearchAddress(address) {
    document.getElementById('searchType').value = 'address';
    document.getElementById('searchInput').value = address;
    performSearch();
  }
  
  function switchTab(showId, hideId) {
    document.getElementById(showId).classList.add('active');
    document.getElementById(hideId).classList.remove('active');
    
    document.querySelector(`.tab[onclick="switchTab('${showId}', '${hideId}')"]`).classList.add('active');
    document.querySelector(`.tab[onclick="switchTab('${hideId}', '${showId}')"]`).classList.remove('active');
  }
</script>

</body>
</html>
