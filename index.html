<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Paper Wallet Generator</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #canvas {
            background-color: white;
            border: 1px solid #ccc;
            margin: 20px auto;
            cursor: pointer;
        }
        .wallet-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print {
                display: none;
            }
            .print-only {
                display: block;
            }
            body {
                background: none;
            }
            .wallet-container {
                box-shadow: none;
                padding: 0;
            }
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #f7931a;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
        }
    </style>
</head>
<body>
    <div class="wallet-container">
        <h1>Bitcoin Paper Wallet Generator</h1>
        <p>Muovi il mouse o digita nella casella per generare entropia</p>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'Single')">Singolo Wallet</button>
            <button class="tablinks" onclick="openTab(event, 'Bulk')">Generazione Multipla</button>
        </div>
        
        <div id="Single" class="tabcontent" style="display: block;">
            <canvas id="canvas" width="600" height="300"></canvas>
            <div id="addressDisplay"></div>
            <div id="privkeyDisplay" style="margin-top: 20px;"></div>
            <button onclick="printWallet()" class="no-print">Stampa Wallet</button>
            <div class="print-only">
                <h2>BITCOIN PAPER WALLET</h2>
                <p>Scansiona il QR code per accedere ai fondi</p>
                <div id="printArea"></div>
            </div>
        </div>
        
        <div id="Bulk" class="tabcontent">
            <p>Quanti wallet vuoi generare? (Max 20)</p>
            <input type="number" id="walletCount" min="1" max="20" value="5">
            <button onclick="generateBulkWallets()">Genera</button>
            <div id="bulkWallets"></div>
        </div>
    </div>

    <!-- Librerie -->
    <script src="https://cdn.jsdelivr.net/npm/tiny-secp256k1@2.2.1/dist/tiny-secp256k1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ecpair@2.0.1/dist/ecpair.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@5.2.0/dist/bitcoinjs-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <script>
        // Inizializzazione
        let entropy = '';
        let walletGenerated = false;
        const ecc = tinysecp;
        ECPair.inject(ecc);
        
        // Elementi UI
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const addressDisplay = document.getElementById('addressDisplay');
        const privkeyDisplay = document.getElementById('privkeyDisplay');
        
        // Animazione iniziale
        function drawRandomPattern() {
            if(walletGenerated) return;
            
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for(let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 5;
                const r = Math.floor(Math.random() * 255);
                const g = Math.floor(Math.random() * 255);
                const b = Math.floor(Math.random() * 255);
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fill();
            }
            
            requestAnimationFrame(drawRandomPattern);
        }
        
        // Raccolta entropia
        function collectEntropy(event) {
            if(walletGenerated) return;
            
            entropy += event.type === 'mousemove' ? 
                `${event.clientX},${event.clientY},${Date.now()}|` : 
                `${event.key},${Date.now()}|`;
            
            // Quando abbiamo abbastanza entropia, genera il wallet
            if(entropy.length > 500) {
                generateWallet();
            }
        }
        
        // Genera wallet
        function generateWallet() {
            walletGenerated = true;
            
            // Hash dell'entropia
            const hash = bitcoin.crypto.sha256(Buffer.from(entropy));
            const keyPair = ECPair.fromPrivateKey(hash, { network: bitcoin.networks.bitcoin });
            
            const wif = keyPair.toWIF();
            const { address } = bitcoin.payments.p2pkh({ 
                pubkey: keyPair.publicKey,
                network: bitcoin.networks.bitcoin 
            });
            
            // Mostra i QR code
            displayWallet(address, wif);
        }
        
        // Visualizza wallet
        function displayWallet(address, wif) {
            // Pulisci canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Disegna indirizzo pubblico
            QRCode.toCanvas(canvas, address, { 
                width: 120,
                margin: 2,
                color: { dark: '#000000', light: '#ffffff' }
            }, function(error) {
                if (error) console.error(error);
                
                ctx.fillStyle = 'black';
                ctx.font = '14px Arial';
                ctx.fillText('Public Address (Receive)', 150, 30);
                ctx.font = '10px Arial';
                ctx.fillText(address, 150, 50);
                
                // Genera QR code chiave privata
                const privKeyCanvas = document.createElement('canvas');
                QRCode.toCanvas(privKeyCanvas, wif, { 
                    width: 120,
                    margin: 2,
                    color: { dark: '#000000', light: '#ffffff' }
                }, function(error) {
                    if (error) console.error(error);
                    
                    ctx.drawImage(privKeyCanvas, 0, 150);
                    ctx.fillStyle = 'black';
                    ctx.font = '14px Arial';
                    ctx.fillText('Private Key (Funds Access)', 150, 180);
                    ctx.font = '10px Arial';
                    ctx.fillText(wif, 150, 200);
                    
                    // Prepara area stampa
                    document.getElementById('printArea').innerHTML = `
                        <div style="text-align: center; margin-bottom: 40px;">
                            <h3>Public Address</h3>
                            <canvas id="printPubQR" width="200" height="200"></canvas>
                            <p>${address}</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>Private Key</h3>
                            <canvas id="printPrivQR" width="200" height="200"></canvas>
                            <p>${wif}</p>
                        </div>
                    `;
                    
                    QRCode.toCanvas(document.getElementById('printPubQR'), address, { width: 200 });
                    QRCode.toCanvas(document.getElementById('printPrivQR'), wif, { width: 200 });
                });
            });
        }
        
        // Generazione multipla
        function generateBulkWallets() {
            const count = parseInt(document.getElementById('walletCount').value);
            let output = '';
            
            for(let i = 0; i < count; i++) {
                const hash = bitcoin.crypto.sha256(Buffer.from(entropy + i + Date.now()));
                const keyPair = ECPair.fromPrivateKey(hash, { network: bitcoin.networks.bitcoin });
                const wif = keyPair.toWIF();
                const { address } = bitcoin.payments.p2pkh({ 
                    pubkey: keyPair.publicKey,
                    network: bitcoin.networks.bitcoin 
                });
                
                output += `
                    <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                        <h3>Wallet ${i+1}</h3>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>Private Key:</strong> ${wif}</p>
                    </div>
                `;
            }
            
            document.getElementById('bulkWallets').innerHTML = output;
        }
        
        // Stampa wallet
        function printWallet() {
            window.print();
        }
        
        // Gestione tab
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Event listeners
        canvas.addEventListener('mousemove', collectEntropy);
        document.addEventListener('keypress', collectEntropy);
        
        // Avvia animazione
        drawRandomPattern();
    </script>
</body>
</html>
